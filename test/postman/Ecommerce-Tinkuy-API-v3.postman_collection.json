{
  "info": {
    "name": "Ecommerce-Tinkuy API v3",
    "_postman_id": "8b7e8f0f-2f3b-5b32-0dbb-2c3d4e5f7a8b",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Colección completa con validaciones HTML5, variantes opcionales, exportar CSV y mensajes admin. Actualizada Diciembre 2025."
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "exec": [
          "const session = pm.environment.get('session_cookie');",
          "if (session) {",
          "  pm.request.headers.add({ key: 'Cookie', value: `PHPSESSID=${session}` });",
          "}"
        ],
        "type": "text/javascript"
      }
    }
  ],
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Login - Usuario válido",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=login",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "email", "value": "vendedor@test.com"},
                {"key": "password", "value": "123456"}
              ]
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Redirección o 200', () => {",
                "  pm.expect([200, 302]).to.include(pm.response.code);",
                "});",
                "const phpsessid = pm.cookies.get('PHPSESSID');",
                "if (phpsessid) { pm.environment.set('session_cookie', phpsessid); }"
              ]
            }
          }]
        },
        {
          "name": "Login - Credenciales inválidas",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=login",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "email", "value": "noexiste@test.com"},
                {"key": "password", "value": "wrongpass"}
              ]
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Mensaje de error', () => {",
                "  pm.expect(pm.response.text()).to.include('Credenciales');",
                "});"
              ]
            }
          }]
        },
        {
          "name": "Registro - Nuevo usuario",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=register",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "nombre", "value": "Juan Test"},
                {"key": "apellido", "value": "Perez"},
                {"key": "email", "value": "test{{$randomInt}}@example.com"},
                {"key": "password", "value": "123456"},
                {"key": "confirmar_password", "value": "123456"},
                {"key": "id_rol", "value": "3"}
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Productos",
      "item": [
        {
          "name": "Listar productos públicos",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=index"
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Status 200', () => pm.response.to.have.status(200));"
              ]
            }
          }]
        },
        {
          "name": "Ver detalle producto",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=producto&id=1"
          }
        },
        {
          "name": "Vendedor - Agregar producto con variantes",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "multipart/form-data"}],
            "url": "{{baseUrl}}?page=vendedor_agregar_producto",
            "body": {
              "mode": "formdata",
              "formdata": [
                {"key": "nombre_producto", "value": "Poncho Artesanal Test"},
                {"key": "descripcion", "value": "Descripción mínima de 10 caracteres"},
                {"key": "id_categoria", "value": "1"},
                {"key": "variantes[1][talla]", "value": "M"},
                {"key": "variantes[1][color]", "value": "Rojo"},
                {"key": "variantes[1][precio]", "value": "150.50"},
                {"key": "variantes[1][stock]", "value": "10"}
              ]
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Validación nombre minlength=10', () => {",
                "  const body = pm.request.body.formdata.toObject();",
                "  pm.expect(body.nombre_producto.length).to.be.at.least(10);",
                "});"
              ]
            }
          }]
        },
        {
          "name": "Vendedor - Producto sin variantes (Única/Estándar)",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "multipart/form-data"}],
            "url": "{{baseUrl}}?page=vendedor_agregar_producto",
            "body": {
              "mode": "formdata",
              "formdata": [
                {"key": "nombre_producto", "value": "Instrumento Musical Único"},
                {"key": "descripcion", "value": "Charango artesanal hecho a mano"},
                {"key": "id_categoria", "value": "5"},
                {"key": "variantes[1][talla]", "value": ""},
                {"key": "variantes[1][color]", "value": ""},
                {"key": "variantes[1][precio]", "value": "250.00"},
                {"key": "variantes[1][stock]", "value": "1"}
              ]
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Backend asigna Única/Estándar', () => {",
                "  // Espera que el backend procese vacío como 'Única' y 'Estándar'",
                "  pm.expect(pm.response.code).to.be.oneOf([200, 302]);",
                "});"
              ]
            }
          }]
        },
        {
          "name": "Vendedor - Editar producto",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=vendedor_editar_producto&id=1",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "accion", "value": "actualizar_producto"},
                {"key": "nombre_producto", "value": "Nombre Actualizado Min 10 Chars"},
                {"key": "descripcion", "value": "Nueva descripción con mínimo 10 caracteres"},
                {"key": "id_categoria", "value": "2"}
              ]
            }
          }
        },
        {
          "name": "Admin - Editar producto",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=admin_editar_producto&id=1",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "accion", "value": "actualizar_producto"},
                {"key": "nombre_producto", "value": "Admin Edit Min 10"},
                {"key": "descripcion", "value": "Descripción editada por admin"}
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Carrito",
      "item": [
        {
          "name": "Ver carrito",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=cart"
          }
        },
        {
          "name": "Agregar al carrito",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=agregar_carrito",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "id_variante", "value": "1"},
                {"key": "cantidad", "value": "2"}
              ]
            }
          }
        },
        {
          "name": "Eliminar del carrito",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=eliminar_carrito&id=1"
          }
        }
      ]
    },
    {
      "name": "Pago y Pedidos",
      "item": [
        {
          "name": "Ver pago (vista)",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=pago"
          }
        },
        {
          "name": "Ver mis pedidos",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=pedidos"
          }
        }
      ]
    },
    {
      "name": "Vendedor",
      "item": [
        {
          "name": "Dashboard vendedor",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=vendedor_dashboard"
          }
        },
        {
          "name": "Listar mis productos",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=vendedor_productos"
          }
        },
        {
          "name": "Mis ventas",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=vendedor_ventas"
          }
        },
        {
          "name": "Exportar CSV ventas",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=vendedor_ventas_csv"
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Content-Type CSV', () => {",
                "  pm.expect(pm.response.headers.get('Content-Type')).to.include('text/csv');",
                "});",
                "pm.test('Filename con fecha', () => {",
                "  const disposition = pm.response.headers.get('Content-Disposition');",
                "  pm.expect(disposition).to.include('ventas_');",
                "  pm.expect(disposition).to.include('.csv');",
                "});"
              ]
            }
          }]
        },
        {
          "name": "Actualizar perfil vendedor - Validaciones",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=mi_perfil_vendedor",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "accion", "value": "actualizar_perfil_vendedor"},
                {"key": "nombre", "value": "Juan Carlos"},
                {"key": "apellido", "value": "Perez Lopez"},
                {"key": "telefono", "value": "987654321"},
                {"key": "nombre_tienda", "value": "Artesanías Don Juan"},
                {"key": "descripcion_tienda", "value": "Venta de productos artesanales peruanos"}
              ]
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Nombre solo letras (pattern)', () => {",
                "  const nombre = pm.request.body.urlencoded.toObject().nombre;",
                "  pm.expect(nombre).to.match(/^[a-zA-ZÁ-úÑñ\\s]+$/);",
                "});",
                "pm.test('Teléfono 9 dígitos', () => {",
                "  const tel = pm.request.body.urlencoded.toObject().telefono;",
                "  pm.expect(tel).to.match(/^[0-9]{9}$/);",
                "});"
              ]
            }
          }]
        }
      ]
    },
    {
      "name": "Admin",
      "item": [
        {
          "name": "Dashboard admin",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=admin_dashboard"
          }
        },
        {
          "name": "Listar usuarios",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=admin_usuarios"
          }
        },
        {
          "name": "Listar productos (admin)",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=admin_productos"
          }
        },
        {
          "name": "Mensajes de contacto",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=admin_mensajes"
          }
        },
        {
          "name": "Ver mensaje detalle",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}?page=admin_mensajes&accion=ver&id=1"
          }
        },
        {
          "name": "Marcar mensaje como respondido",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=admin_mensajes",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "accion", "value": "marcar_respondido"},
                {"key": "id", "value": "1"}
              ]
            }
          }
        },
        {
          "name": "Reportes - Ventas",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=admin_reportes",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "tipo_reporte", "value": "ventas"},
                {"key": "fecha_inicio", "value": "2025-01-01"},
                {"key": "fecha_fin", "value": "2025-12-31"}
              ]
            }
          }
        },
        {
          "name": "Reportes - Exportar Excel",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=admin_reportes",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "tipo_reporte", "value": "productos"},
                {"key": "formato", "value": "excel"}
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Contacto",
      "item": [
        {
          "name": "Enviar mensaje - Validaciones",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
            "url": "{{baseUrl}}?page=contact",
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "nombre", "value": "Juan Perez"},
                {"key": "email", "value": "test@example.com"},
                {"key": "asunto", "value": "Consulta producto"},
                {"key": "mensaje", "value": "Hola, quisiera más información sobre este producto."}
              ]
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Nombre solo letras', () => {",
                "  const nombre = pm.request.body.urlencoded.toObject().nombre;",
                "  pm.expect(nombre).to.match(/^[a-zA-ZÁ-úÑñ\\s]+$/);",
                "});",
                "pm.test('Asunto máx 30 caracteres', () => {",
                "  const asunto = pm.request.body.urlencoded.toObject().asunto;",
                "  pm.expect(asunto.length).to.be.at.most(30);",
                "});"
              ]
            }
          }]
        }
      ]
    },
    {
      "name": "IA - DeepSeek",
      "item": [
        {
          "name": "Búsqueda válida (200)",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "url": "{{basePublic}}/deepseek_search.php",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"chompa de alpaca\"\n}"
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Status 200', () => pm.response.to.have.status(200));",
                "const json = pm.response.json();",
                "pm.test('Tiene texto', () => pm.expect(json.texto).to.be.a('string').and.not.empty);"
              ]
            }
          }]
        },
        {
          "name": "Query vacío (400)",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "url": "{{basePublic}}/deepseek_search.php",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"\"\n}"
            }
          },
          "event": [{
            "listen": "test",
            "script": {
              "exec": [
                "pm.test('Status 400', () => pm.response.to.have.status(400));"
              ]
            }
          }]
        }
      ]
    }
  ]
}
